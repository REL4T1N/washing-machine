from aiogram import Router
from aiogram.filters import CommandStart, Command
from aiogram.types import Message
from aiogram.utils.markdown import hlink

from services.storage import UserStorage
from config.settings import GoogleSettings

router = Router()

# --- Хендлер команды /start ---
@router.message(CommandStart())
async def cmd_start(
    message: Message, 
    storage: UserStorage,
    google_settings: GoogleSettings    
):
    user_id = message.from_user.id
    user = storage.get_user(user_id)

    # 1. Если пользователя вообще нет в базе
    if not user:
        await storage.add_user(user_id)
        table_link = hlink("таблице", google_settings.full_url)
        text = (
            "Добро пожаловать, новый пользователь! "
            f"Данный бот предназначен для учёта в записи {table_link}"
        )
        await message.answer(text, parse_mode="HTML")
        return

    # 2. Если пользователь есть, проверяем поле name
    name = user.get("name")
    
    if name:
        # Пользователь есть и имя задано
        text = (
            f"Здравствуйте, {name}\n\n"
            "Доступные команды:\n"
            "/table - загрузка актуальной таблицы\n"
            "/bookings - управление активными записями\n"
            "/name - установка нового имени\n"
            "/help - инструкция по использованию и ответы на вопросы"            
        )
        await message.answer(text)
    else:
        # Пользователь есть, но имени нет (повторный /start без регистрации)
        await message.answer(
            "Добро пожаловать! Чтобы продолжить пользоваться ботом, необходимо указать имя командой /name, например, /name Иван.\n"
            "Данное имя будет использоваться в дальнейшем и его можно изменить в любой момент."
        )

# --- Команда /help ---
async def cmd_help(message: Message, google_settings: GoogleSettings):
    table_link = hlink("таблице", google_settings.full_url)
    text = (
        "<b>Справка по работе с ботом</b>\n\n"
        "<b>1. Как записаться?</b>\n"
        "- Укажите ваше имя командой /name.\n"
        "- Загрузите актуальное расписание командой /table.\n"
        "- Нажмите кнопку 'Записаться'.\n"
        "- Выберите подходящий день недели (рядом с днём указана дата).\n"
        "- Выберите свободный временной слот.\n"
        "- Дождитесь сообщения об успешной записи. В случае ошибки, попробуйте повторить.\n\n"
        "<b>2. Как отменить запись?</b>\n"
        "- Вызовите список своих записей командой /bookings или кнопкой 'Мои записи'.\n"
        "- Если у вас есть активные записи, выберите ту, которую хотите отменить, и подтвердите удаление.\n\n"
        "<b>3. Можно ли удалить все записи сразу?</b>\n"
        "- Нет, такая функция не предусмотрена. Записи удаляются по одной.\n\n"
        "<b>4. Какая запись считается активной?</b>\n"
        "- Активной считается любая запись на текущую или будущую дату. Записи на прошедшие даты считаются архивными.\n\n"
        "<b>5. Что будет, если дата прошла, а я не удалил запись?</b>\n"
        "- Ничего страшного. Запись автоматически станет неактивной и со временем будет удалена.\n\n"
        "<b>6. Можно ли получить историю записей через бота?</b>\n"
        "- Да, историю можно получить по запросу у администратора.\n\n"
        "<b>7. Кнопки не реагируют. Что делать?</b>\n"
        f"- Иногда могут быть задержки в ответе сервера. Пожалуйста, подождите немного и попробуйте снова. Можно проверить состояние в {table_link}. Если проблема сохраняется, свяжитесь с администратором.\n\n"
        "<b>8. Обратная связь:</b>\n"
        "- Данный раздел находится в разработке."
    )
    await message.answer(text)